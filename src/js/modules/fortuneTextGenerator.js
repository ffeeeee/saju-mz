/**
 * fortuneTextGenerator.js - 상세 사주 분석 텍스트 생성
 * 11개 섹션, 각 300-500+ 단어, 총 ~4,500단어 (30분 분량)
 * 일간별 기본 텍스트 + 십신 보정 + 오행 균형 + 계절/합충 상호작용
 */

export class FortuneTextGenerator {
  /**
   * 전체 분석 텍스트 생성
   * @param {Object} sajuResult - SajuCalculator 결과
   * @param {Object} sipsinResult - SipsinAnalyzer 결과
   * @param {Object} daewoonResult - DaewoonCalculator 결과
   * @returns {Object} 11개 섹션 텍스트
   */
  generate(sajuResult, sipsinResult, daewoonResult) {
    const ctx = this.buildContext(sajuResult, sipsinResult, daewoonResult);

    return {
      basicAnalysis: this.generateBasicAnalysis(ctx),
      elementAnalysis: this.generateElementAnalysis(ctx),
      sipsinAnalysis: this.generateSipsinAnalysis(ctx),
      daewoonAnalysis: this.generateDaewoonAnalysis(ctx),
      personality: this.generatePersonality(ctx),
      romance: this.generateRomance(ctx),
      wealth: this.generateWealth(ctx),
      career: this.generateCareer(ctx),
      health: this.generateHealth(ctx),
      yearFortune: this.generateYearFortune(ctx),
      advice: this.generateAdvice(ctx)
    };
  }

  /**
   * 분석에 필요한 컨텍스트 구성
   */
  buildContext(sajuResult, sipsinResult, daewoonResult) {
    const dm = sajuResult.dayMaster;
    const dmElement = sajuResult.dayMasterElement;
    const dmYinYang = sajuResult.dayMasterYinYang;
    const gender = sajuResult.gender;
    const genderKo = gender === 'male' ? '남성' : '여성';
    const pillars = sajuResult.pillars;
    const elements = sajuResult.elements;
    const sipsin = sipsinResult;
    const daewoon = daewoonResult;
    const dominant = sipsinResult.dominant;

    // 계절 판별 (월지 기준)
    const monthBranch = pillars.month.branch;
    const season = this.getSeason(monthBranch);

    // 일간 강약 판단
    const strength = this.judgeDayMasterStrength(sajuResult, sipsinResult);

    return {
      dm, dmElement, dmYinYang, gender, genderKo,
      pillars, elements, sipsin, daewoon, dominant,
      season, strength, name: sajuResult.name
    };
  }

  getSeason(monthBranch) {
    const seasonMap = {
      '인': '봄', '묘': '봄', '진': '봄',
      '사': '여름', '오': '여름', '미': '여름',
      '신': '가을', '유': '가을', '술': '가을',
      '해': '겨울', '자': '겨울', '축': '겨울'
    };
    return seasonMap[monthBranch] || '봄';
  }

  judgeDayMasterStrength(sajuResult, sipsinResult) {
    const dominant = sipsinResult.dominant;
    const bigyeop = dominant.groups['비겁'] || 0;
    const inseong = dominant.groups['인성'] || 0;
    const helpCount = bigyeop + inseong;

    // 득령(월지가 일간을 도와주는지) 체크
    const monthBranchEl = sajuResult.pillars.month.branchElement;
    const dmEl = sajuResult.dayMasterElement;
    const cycle = ['목', '화', '토', '금', '수'];
    const dmIdx = cycle.indexOf(dmEl);
    const mbIdx = cycle.indexOf(monthBranchEl);
    const deukryeong = (dmEl === monthBranchEl) || ((mbIdx + 1) % 5 === dmIdx);

    if (helpCount >= 4 || (helpCount >= 3 && deukryeong)) {
      return { level: 'strong', description: '신강(身强)', detail: '일간의 기운이 강하여 자아가 확고합니다.' };
    } else if (helpCount <= 1 && !deukryeong) {
      return { level: 'weak', description: '신약(身弱)', detail: '일간의 기운이 약하여 도움이 필요합니다.' };
    }
    return { level: 'balanced', description: '중화(中和)', detail: '일간의 기운이 적절히 균형잡혀 있습니다.' };
  }

  // =====================================================
  // 1. 사주팔자 기본 분석
  // =====================================================
  generateBasicAnalysis(ctx) {
    const { dm, dmElement, dmYinYang, pillars, name, genderKo, strength, season } = ctx;

    const elementNames = { '목': '나무', '화': '불', '토': '흙', '금': '쇠', '수': '물' };
    const dmName = elementNames[dmElement];
    const yearP = pillars.year.display;
    const monthP = pillars.month.display;
    const dayP = pillars.day.display;
    const hourP = pillars.hour ? pillars.hour.display : '(시간 미상)';

    let text = `<h4>사주 명식 해석</h4>`;
    text += `<p><strong>${name}</strong>님(${genderKo})의 사주 명식을 살펴보겠습니다.</p>`;
    text += `<p>사주팔자란 태어난 해(년주), 달(월주), 날(일주), 시간(시주) 네 기둥(四柱)에 각각 천간과 지지 두 글자(八字)로 구성된 것입니다. ${name}님의 사주 네 기둥은 다음과 같습니다.</p>`;

    text += `<p><strong>년주:</strong> ${yearP} | <strong>월주:</strong> ${monthP} | <strong>일주:</strong> ${dayP} | <strong>시주:</strong> ${hourP}</p>`;

    text += `<p>사주에서 가장 핵심이 되는 것은 <strong>일간(日干)</strong>입니다. 일간은 "나 자신"을 나타내는 글자로, ${name}님의 일간은 <strong>${dm}(${dmYinYang}${dmElement})</strong>입니다. ${dmYinYang}의 ${dmName} 기운을 가진 분으로, 이것이 ${name}님의 근본적인 성품과 기질을 결정합니다.</p>`;

    text += `<p>${ctx.sipsin.profile.dayMasterDescription}</p>`;

    text += `<p>년주 <strong>${yearP}</strong>은 조상궁이자 어린 시절의 환경을 나타냅니다. ${pillars.year.element} 기운의 천간과 ${pillars.year.branchElement} 기운의 지지가 조합되어 있습니다.</p>`;

    text += `<p>월주 <strong>${monthP}</strong>은 부모궁이자 청년기의 운을 나타냅니다. 또한 사회적 성향과 직업적 적성을 보여주는 중요한 기둥입니다. ${season}에 태어나셨으므로 ${this.getSeasonalInfluence(dmElement, season)} 계절의 영향을 받습니다.</p>`;

    text += `<p>일주 <strong>${dayP}</strong>는 본인과 배우자궁을 나타냅니다. 일간 ${dm}이 본인이라면, 일지 ${pillars.day.branch}(${pillars.day.branchElement})은 배우자의 성향과 가정환경을 보여줍니다.</p>`;

    if (pillars.hour) {
      text += `<p>시주 <strong>${hourP}</strong>는 자녀궁이자 말년의 운을 나타냅니다. ${pillars.hour.element} 기운의 천간과 ${pillars.hour.branchElement} 기운의 지지로 구성되어 있습니다.</p>`;
    }

    text += `<p>사주 전체의 강약을 살펴보면, ${name}님은 <strong>${strength.description}</strong>한 사주입니다. ${strength.detail}</p>`;

    return text;
  }

  getSeasonalInfluence(element, season) {
    const influences = {
      '목': { '봄': '목이 왕성한', '여름': '화기를 생하여 설기되는', '가을': '금에 의해 극을 받는', '겨울': '수의 생을 받는' },
      '화': { '봄': '목의 생을 받는', '여름': '화가 왕성한', '가을': '토를 생하여 설기되는', '겨울': '수에 의해 극을 받는' },
      '토': { '봄': '목에 의해 극을 받는', '여름': '화의 생을 받는', '가을': '금을 생하여 설기되는', '겨울': '수를 극하지만 힘이 빠지는' },
      '금': { '봄': '화의 극을 받기 쉬운', '여름': '화에 의해 극을 받는', '가을': '금이 왕성한', '겨울': '수를 생하여 설기되는' },
      '수': { '봄': '목을 생하여 설기되는', '여름': '화에 의해 극을 받는', '가을': '금의 생을 받는', '겨울': '수가 왕성한' }
    };
    return influences[element]?.[season] || '';
  }

  // =====================================================
  // 2. 오행 분석
  // =====================================================
  generateElementAnalysis(ctx) {
    const { elements, dmElement, dm, name, strength } = ctx;
    const { count, strongest, weakest, missing } = elements;

    const elementInfo = {
      '목': { name: '목(木, 나무)', organ: '간/담', emotion: '분노', color: '청색/녹색', direction: '동쪽', season: '봄' },
      '화': { name: '화(火, 불)', organ: '심장/소장', emotion: '기쁨', color: '적색', direction: '남쪽', season: '여름' },
      '토': { name: '토(土, 흙)', organ: '비/위', emotion: '사려', color: '황색', direction: '중앙', season: '환절기' },
      '금': { name: '금(金, 쇠)', organ: '폐/대장', emotion: '슬픔', color: '백색', direction: '서쪽', season: '가을' },
      '수': { name: '수(水, 물)', organ: '신장/방광', emotion: '공포', color: '흑색', direction: '북쪽', season: '겨울' }
    };

    let text = `<h4>오행의 균형과 상호작용</h4>`;
    text += `<p>오행(五行)은 목(木)·화(火)·토(土)·금(金)·수(水) 다섯 가지 기운으로, 우주 만물의 생성과 변화의 원리입니다. ${name}님의 사주에 나타난 오행 분포를 분석해 보겠습니다.</p>`;

    text += `<p><strong>오행 분포:</strong> 목(${count['목']}) · 화(${count['화']}) · 토(${count['토']}) · 금(${count['금']}) · 수(${count['수']})</p>`;

    text += `<p>가장 강한 오행은 <strong>${elementInfo[strongest.element].name}</strong>(${strongest.count}개)입니다. `;

    // 강한 오행 해석
    const strongEl = elementInfo[strongest.element];
    text += `${strongest.element} 기운이 강하다는 것은 ${strongEl.season}의 기운, ${strongEl.direction}의 방향, ${strongEl.emotion}의 감정과 깊은 연관이 있습니다. 장부로는 ${strongEl.organ}과 관련되며, 이 부분이 활발하거나 과도하게 작용할 수 있습니다.</p>`;

    // 약한 오행 해석
    if (missing.length > 0) {
      text += `<p>사주에서 <strong>${missing.map(m => elementInfo[m].name).join(', ')}</strong>이(가) 부족합니다. `;
      missing.forEach(m => {
        const info = elementInfo[m];
        text += `${m} 기운이 부족하면 ${info.organ} 관련 건강에 주의가 필요하고, ${info.emotion}의 감정을 다루는 데 어려움이 있을 수 있습니다. ${info.color} 계열의 색상이나 ${info.direction} 방향이 보완에 도움이 됩니다. `;
      });
      text += `</p>`;
    } else {
      text += `<p>다행히 사주에 오행이 모두 갖춰져 있어 큰 결함은 없습니다. 다만 가장 약한 <strong>${elementInfo[weakest.element].name}</strong>(${weakest.count}개)을 보완해주면 더욱 좋습니다.</p>`;
    }

    // 상생상극 흐름
    text += `<h4>오행의 상생상극</h4>`;
    text += `<p>오행은 서로 생(生)하고 극(克)하는 관계를 맺습니다. 목생화(木生火), 화생토(火生土), 토생금(土生金), 금생수(金生水), 수생목(水生木)의 상생 관계와, 목극토(木剋土), 토극수(土剋水), 수극화(水剋火), 화극금(火剋金), 금극목(金剋木)의 상극 관계가 있습니다.</p>`;

    text += `<p>${name}님의 일간 ${dm}은 ${dmElement} 기운입니다. `;
    const cycle = ['목', '화', '토', '금', '수'];
    const dmIdx = cycle.indexOf(dmElement);
    const generates = cycle[(dmIdx + 1) % 5];
    const controls = cycle[(dmIdx + 2) % 5];
    const generatedBy = cycle[(dmIdx + 4) % 5];
    const controlledBy = cycle[(dmIdx + 3) % 5];

    text += `${dmElement}은 ${generates}을(를) 생하고, ${controls}을(를) 극하며, ${generatedBy}의 생을 받고, ${controlledBy}의 극을 받습니다. `;

    if (count[generatedBy] >= 2) {
      text += `사주에 ${generatedBy} 기운이 충분하여 일간을 잘 생해주고 있습니다. 이는 학문적 도움이나 윗사람의 지원을 의미합니다. `;
    }
    if (count[controlledBy] >= 2) {
      text += `${controlledBy} 기운이 강하여 일간에 압박을 줄 수 있으나, 이는 자기 성장의 원동력이 될 수도 있습니다. `;
    }

    text += `</p>`;

    // 신강/신약에 따른 용신 제안
    text += `<h4>용신(用神) 방향</h4>`;
    if (strength.level === 'strong') {
      text += `<p>${name}님은 신강한 사주이므로, 일간의 기운을 빼주는 오행(식상·재성)이 용신이 될 수 있습니다. ${generates}(식상)이나 ${controls}(재성) 기운을 활용하면 삶의 균형을 찾을 수 있습니다. 활동적이고 생산적인 일에 에너지를 쏟는 것이 좋습니다.</p>`;
    } else if (strength.level === 'weak') {
      text += `<p>${name}님은 신약한 사주이므로, 일간을 도와주는 오행(비겁·인성)이 용신이 될 수 있습니다. ${dmElement}(비겁)이나 ${generatedBy}(인성) 기운을 보충해주면 좋습니다. 같은 기운의 사람이나 환경에서 힘을 얻을 수 있습니다.</p>`;
    } else {
      text += `<p>${name}님은 중화된 사주이므로, 특정 오행에 크게 치우치지 않습니다. 상황에 따라 필요한 오행을 보충하며 유연하게 대처하는 것이 좋습니다. 전체적인 균형이 잘 잡혀 있어 안정적인 삶을 영위할 수 있는 기본 틀을 갖추고 있습니다.</p>`;
    }

    return text;
  }

  // =====================================================
  // 3. 십신 분석
  // =====================================================
  generateSipsinAnalysis(ctx) {
    const { sipsin, dm, name, genderKo } = ctx;
    const { sipsinCount, dominant } = sipsin;

    let text = `<h4>십신(十神)으로 보는 인생의 구조</h4>`;
    text += `<p>십신은 일간(나)을 중심으로 다른 천간·지지와의 관계를 열 가지로 분류한 것입니다. 이를 통해 ${name}님의 성격, 대인관계, 재물, 직업, 건강 등 삶의 전반적인 경향을 파악할 수 있습니다.</p>`;

    // 각 십신 그룹별 해석
    const groups = dominant.groups;
    const sorted = dominant.sorted;

    text += `<p><strong>십신 분포:</strong> `;
    sorted.forEach(([group, count]) => {
      text += `${group}(${count}) `;
    });
    text += `</p>`;

    // 비겁 (비견 + 겁재)
    text += `<h4>비겁(比劫) - 나와 같은 기운</h4>`;
    if (groups['비겁'] >= 3) {
      text += `<p>비겁이 강한 ${name}님은 자아가 뚜렷하고 독립심이 강합니다. 주관이 뚜렷하여 남에게 쉽게 휘둘리지 않으며, 스스로 결정하고 행동하는 것을 선호합니다. 다만 고집이 세다는 평가를 받을 수 있으며, 재물이 새어나가기 쉬우니 동업이나 보증에 주의가 필요합니다. 경쟁심이 강하고 승부욕이 있어 목표를 향해 강하게 밀어붙이는 성향이 있습니다.</p>`;
    } else if (groups['비겁'] >= 1) {
      text += `<p>비겁이 적당히 있어 자아 정체성이 안정적입니다. 독립심과 협조성이 균형 잡혀 있으며, 필요할 때 주변의 도움을 받으면서도 자기 주관을 유지할 수 있습니다. 형제자매나 동료와의 관계도 원만한 편입니다.</p>`;
    } else {
      text += `<p>비겁이 부족한 편입니다. 자기 주장보다 타인의 의견을 따르는 경향이 있으며, 독립적으로 일을 추진하는 데 어려움을 느낄 수 있습니다. 형제자매나 동료의 도움이 부족할 수 있으니 스스로 힘을 기르는 것이 중요합니다.</p>`;
    }

    // 식상 (식신 + 상관)
    text += `<h4>식상(食傷) - 표현과 창의의 기운</h4>`;
    if (groups['식상'] >= 3) {
      text += `<p>식상이 강한 ${name}님은 표현력과 창의력이 뛰어납니다. 말재주가 좋고 예술적 감각이 있으며, 자유로운 사고를 합니다. 기존의 틀에 얽매이기 싫어하고 새로운 것을 추구합니다. 다만 너무 자유분방하면 직장생활에서 마찰이 생길 수 있으니, 적절한 자기 절제가 필요합니다. ${genderKo === '여성' ? '여성의 경우 식상은 자녀를 나타내기도 하여 자녀와의 인연이 깊습니다.' : '남성의 경우 식상은 활동력과 재능을 나타내어 기술이나 예술 분야에서 능력을 발휘할 수 있습니다.'}</p>`;
    } else if (groups['식상'] >= 1) {
      text += `<p>식상이 적당히 있어 자기 표현력이 양호합니다. 필요할 때 자신의 생각을 잘 전달하며, 적절한 창의성을 발휘합니다. 음식복이 있고 건강 관리에도 관심이 많은 편입니다.</p>`;
    } else {
      text += `<p>식상이 부족한 편입니다. 자기 표현이 서투르거나 내성적인 면이 있을 수 있습니다. 하고 싶은 말을 참는 경우가 많고, 스트레스를 내면에 쌓아두는 경향이 있습니다. 취미활동이나 창작 활동으로 표현의 통로를 만드는 것이 좋습니다.</p>`;
    }

    // 재성 (편재 + 정재)
    text += `<h4>재성(財星) - 재물과 현실의 기운</h4>`;
    if (groups['재성'] >= 3) {
      text += `<p>재성이 강한 ${name}님은 현실 감각이 뛰어나고 재물에 대한 감각이 좋습니다. 돈을 버는 능력이 있으며 경제적 활동에 적극적입니다. 다만 재성이 과다하면 일간이 약해질 수 있어 체력 관리가 중요합니다. ${genderKo === '남성' ? '남성에게 재성은 배우자(처)를 의미하기도 하여 이성과의 인연이 많을 수 있습니다.' : '여성에게 재성은 경제적 자립 능력을 나타내어 재정적으로 독립적인 삶을 영위할 수 있습니다.'} 물질적 풍요를 누리되, 건강과 정신적 여유도 함께 챙기시길 바랍니다.</p>`;
    } else if (groups['재성'] >= 1) {
      text += `<p>재성이 적당히 있어 재물 운이 안정적입니다. 무리하지 않으면 꾸준한 수입을 유지할 수 있으며, 현실적인 판단력이 양호합니다. 절약과 투자의 균형을 잘 잡는 편입니다.</p>`;
    } else {
      text += `<p>재성이 부족한 편입니다. 물질적인 것보다 정신적 가치를 중시하는 경향이 있습니다. 돈에 대한 관심이 적거나 재물 관리가 서투를 수 있으니, 경제적 계획을 세우는 습관을 들이는 것이 좋습니다.</p>`;
    }

    // 관성 (편관 + 정관)
    text += `<h4>관성(官星) - 직업과 명예의 기운</h4>`;
    if (groups['관성'] >= 3) {
      text += `<p>관성이 강한 ${name}님은 책임감이 강하고 규율을 중시합니다. 조직 내에서 인정받기 쉬우며, 공직이나 대기업 같은 안정된 조직에서 능력을 발휘합니다. 다만 관성이 과다하면 스트레스나 압박을 많이 받을 수 있습니다. ${genderKo === '여성' ? '여성에게 관성은 배우자(남편)를 의미하기도 하여 배우자의 영향이 큰 편입니다.' : '남성에게 관성은 직장이나 사회적 지위를 나타내어 승진이나 사회적 성취에 관심이 많습니다.'} 지나친 부담을 스스로에게 지우지 않도록 적절한 이완이 필요합니다.</p>`;
    } else if (groups['관성'] >= 1) {
      text += `<p>관성이 적당히 있어 사회적 질서와 규범을 잘 따릅니다. 직장생활에 적응력이 좋고, 책임감 있는 태도로 신뢰를 얻습니다. 법이나 규율을 존중하며 사회적으로 안정된 삶을 지향합니다.</p>`;
    } else {
      text += `<p>관성이 부족한 편입니다. 조직의 규율이나 틀에 맞추는 것을 불편해할 수 있습니다. 자유직이나 프리랜서, 자영업이 더 적합할 수 있으며, 자율적인 환경에서 능력을 발휘합니다.</p>`;
    }

    // 인성 (편인 + 정인)
    text += `<h4>인성(印星) - 학문과 지혜의 기운</h4>`;
    if (groups['인성'] >= 3) {
      text += `<p>인성이 강한 ${name}님은 학문적이고 사색적입니다. 배우는 것을 좋아하며 지적 호기심이 강합니다. 어머니나 윗사람의 도움을 많이 받으며, 학력이나 자격증 등 지식 분야에서 성과를 거두기 쉽습니다. 다만 인성이 과다하면 생각이 너무 많아 행동력이 부족할 수 있으며, 의존적인 성향이 나타날 수 있습니다. 배운 것을 실천으로 옮기는 연습이 필요합니다.</p>`;
    } else if (groups['인성'] >= 1) {
      text += `<p>인성이 적당히 있어 학습 능력이 양호합니다. 필요한 지식을 잘 습득하며, 이를 실생활에 적용하는 능력도 있습니다. 부모님이나 선생님 등 윗사람의 관계가 원만한 편입니다.</p>`;
    } else {
      text += `<p>인성이 부족한 편입니다. 학문보다 실전 경험을 통해 배우는 타입일 수 있습니다. 윗사람의 도움이 부족할 수 있으나, 스스로 개척하는 힘이 강합니다. 자격증이나 전문 교육을 통해 인성의 부족을 보완하면 좋습니다.</p>`;
    }

    return text;
  }

  // =====================================================
  // 4. 대운 흐름
  // =====================================================
  generateDaewoonAnalysis(ctx) {
    const { daewoon, name, dm, dmElement } = ctx;
    const { isForward, startAge, daewoons, currentDaewoon, currentAge } = daewoon;

    let text = `<h4>대운(大運)의 흐름</h4>`;
    text += `<p>대운은 10년 단위로 바뀌는 큰 운의 흐름입니다. ${name}님은 <strong>${isForward ? '순행' : '역행'}</strong> 대운으로, ${startAge}세부터 대운이 시작됩니다.</p>`;

    text += `<p>현재 나이(한국식) <strong>${currentAge}세</strong>로, 현재 <strong>${currentDaewoon.display} 대운</strong>(${currentDaewoon.ageRange})을 지나고 계십니다.</p>`;

    // 대운 리스트
    text += `<h4>대운 일람</h4>`;
    text += `<p>`;
    daewoons.forEach(dw => {
      const isCurrent = dw === currentDaewoon;
      if (isCurrent) {
        text += `<strong>→ ${dw.display}(${dw.ageRange}) [현재]</strong> · `;
      } else {
        text += `${dw.display}(${dw.ageRange}) · `;
      }
    });
    text = text.slice(0, -3); // 마지막 · 제거
    text += `</p>`;

    // 현재 대운 상세 해석
    text += `<h4>현재 대운 해석: ${currentDaewoon.display}운</h4>`;
    const cdElement = currentDaewoon.element;
    const cdBranchEl = currentDaewoon.branchElement;

    text += `<p>현재 지나고 있는 ${currentDaewoon.display} 대운의 천간은 ${currentDaewoon.stem}(${cdElement})이고, 지지는 ${currentDaewoon.branch}(${cdBranchEl})입니다. `;

    // 대운과 일간 관계
    const cycle = ['목', '화', '토', '금', '수'];
    const dmIdx = cycle.indexOf(dmElement);
    const cdIdx = cycle.indexOf(cdElement);

    if (dmElement === cdElement) {
      text += `대운의 기운이 일간과 같아 자아가 강해지고 자신감이 넘치는 시기입니다. 주체적으로 일을 추진할 수 있지만, 고집이 세질 수 있으니 주의하세요.</p>`;
    } else if ((dmIdx + 4) % 5 === cdIdx) {
      text += `대운이 일간을 생해주어 도움과 지원이 들어오는 시기입니다. 학업, 자격증, 승진 등에 유리하며 귀인의 도움을 받을 수 있습니다.</p>`;
    } else if ((dmIdx + 1) % 5 === cdIdx) {
      text += `일간이 대운을 생해주어 에너지가 빠져나가는 시기입니다. 활동량이 많아지고 바빠질 수 있습니다. 건강 관리에 신경 쓰세요.</p>`;
    } else if ((dmIdx + 2) % 5 === cdIdx) {
      text += `일간이 대운을 극하여 재물이나 성과를 적극적으로 추구하는 시기입니다. 사업이나 투자에 관심이 높아지며, 재물을 얻을 기회가 있습니다.</p>`;
    } else {
      text += `대운이 일간을 극하여 외부의 압력이나 변화가 있는 시기입니다. 직장에서의 변동이나 사회적 도전이 있을 수 있지만, 이를 통해 성장할 수 있습니다.</p>`;
    }

    // 과거~미래 대운 흐름 요약
    text += `<h4>대운 흐름 요약</h4>`;
    text += `<p>`;
    daewoons.slice(0, 6).forEach(dw => {
      const el = dw.element;
      let quality;
      if (el === dmElement || cycle[(dmIdx + 4) % 5] === el) {
        quality = '안정과 성장';
      } else if (cycle[(dmIdx + 2) % 5] === el) {
        quality = '재물과 성취';
      } else if (cycle[(dmIdx + 3) % 5] === el) {
        quality = '도전과 변화';
      } else {
        quality = '활동과 표현';
      }
      text += `<strong>${dw.display}(${dw.ageRange})</strong>: ${quality}의 시기. `;
    });
    text += `</p>`;

    return text;
  }

  // =====================================================
  // 5. 성격 분석
  // =====================================================
  generatePersonality(ctx) {
    const { dm, dmElement, dmYinYang, name, sipsin, strength, season, genderKo } = ctx;
    const dominant = sipsin.dominant;

    let text = `<h4>${name}님의 타고난 성격</h4>`;

    // 일간 기반 성격
    const personalities = {
      '갑': `<p>${name}님은 <strong>갑목(甲木)</strong> 일간으로, 큰 소나무처럼 곧고 당당한 기질을 타고났습니다. 리더십이 뛰어나고 정의감이 강하여, 불의를 보면 참지 못합니다. 새로운 분야를 개척하고 앞장서는 선구자적 성향이 있으며, 사람들을 이끄는 데 능숙합니다.</p><p>다만 갑목의 강직함은 때로 융통성 부족으로 나타날 수 있습니다. 한 번 결정한 것은 잘 바꾸지 않으며, 자기 방식을 고수하는 경향이 있습니다. 주변의 조언을 경청하는 자세가 필요합니다. 봉사정신이 있고 약자를 돕는 것을 좋아하며, 큰 뜻을 품고 살아가는 사람입니다.</p>`,
      '을': `<p>${name}님은 <strong>을목(乙木)</strong> 일간으로, 풀이나 꽃처럼 유연하고 아름다운 기질을 타고났습니다. 환경에 대한 적응력이 뛰어나고, 부드럽게 사람들의 마음을 얻는 능력이 있습니다. 예술적 감각이 뛰어나며 아름다움을 추구합니다.</p><p>겉으로는 유순해 보이지만 내면에는 강한 생명력이 있습니다. 바위틈에서도 자라나는 잡초처럼 어떤 상황에서도 살아남는 끈기가 있습니다. 처세술이 좋아 대인관계가 원만하며, 외교적 수완이 뛰어납니다.</p>`,
      '병': `<p>${name}님은 <strong>병화(丙火)</strong> 일간으로, 태양처럼 밝고 뜨거운 기질을 타고났습니다. 열정적이고 에너지가 넘치며, 주변 사람들에게 긍정적인 영향을 미칩니다. 카리스마가 있어 자연스럽게 주목받으며, 활달하고 사교적입니다.</p><p>모든 것을 환하게 비추는 태양처럼 숨기는 것이 없고 솔직합니다. 분위기를 밝게 만드는 능력이 있으며, 사람들과 함께하는 것을 좋아합니다. 다만 감정의 기복이 있을 수 있고, 너무 급하게 달려가는 성향을 조절할 필요가 있습니다.</p>`,
      '정': `<p>${name}님은 <strong>정화(丁火)</strong> 일간으로, 촛불이나 별빛처럼 은은하고 따뜻한 기질을 타고났습니다. 내면에 깊은 열정을 가지고 있으면서도 겉으로는 차분하고 조용합니다. 섬세한 감수성과 날카로운 관찰력의 소유자입니다.</p><p>어둠 속에서 빛을 비추는 촛불처럼, 주변 사람들에게 따뜻한 위로와 지혜를 전해줍니다. 학구열이 높고 연구하는 것을 좋아하며, 예술이나 문화 분야에서 뛰어난 재능을 보입니다. 집중력이 강하고 한 분야를 깊이 파고드는 장인 기질이 있습니다.</p>`,
      '무': `<p>${name}님은 <strong>무토(戊土)</strong> 일간으로, 큰 산처럼 듬직하고 안정적인 기질을 타고났습니다. 신뢰감이 있고 포용력이 커서 주변 사람들이 의지합니다. 중립적인 위치에서 갈등을 중재하는 능력이 뛰어납니다.</p><p>변함없는 태도로 사람들에게 안정감을 주며, 어떤 상황에서도 흔들리지 않는 강인함이 있습니다. 약속을 중시하고 한 번 맺은 인연을 소중히 여깁니다. 다만 변화를 두려워하거나 새로운 시도를 꺼릴 수 있으니, 적절한 도전정신이 필요합니다.</p>`,
      '기': `<p>${name}님은 <strong>기토(己土)</strong> 일간으로, 비옥한 논밭처럼 모든 것을 품어주는 기질을 타고났습니다. 세심하고 실용적이며, 주변을 세밀하게 챙기는 어머니같은 따뜻함이 있습니다. 현실 감각이 뛰어나고 실리를 잘 추구합니다.</p><p>겸손하고 착실한 성격으로 주변의 신뢰를 얻으며, 꾸준히 노력하여 성과를 이뤄냅니다. 사소한 것도 놓치지 않는 꼼꼼함이 있으며, 사람들의 필요를 잘 파악합니다. 다만 걱정이 많고 소심한 면이 나올 수 있으니 자신감을 키우는 것이 중요합니다.</p>`,
      '경': `<p>${name}님은 <strong>경금(庚金)</strong> 일간으로, 바위나 무쇠처럼 강하고 결단력 있는 기질을 타고났습니다. 의리를 중시하고 한 번 마음먹으면 끝까지 밀어붙이는 추진력이 있습니다. 불의를 참지 못하며 정의감이 강합니다.</p><p>거침없이 행동하는 스타일로, 결정이 빠르고 실행력이 뛰어납니다. 원칙을 중시하며 약속을 꼭 지키는 사람입니다. 다만 지나치게 직설적이거나 강압적으로 보일 수 있으니, 상대방의 감정을 배려하는 노력이 필요합니다.</p>`,
      '신': `<p>${name}님은 <strong>신금(辛金)</strong> 일간으로, 보석처럼 세련되고 예리한 기질을 타고났습니다. 미적 감각이 뛰어나고 완벽주의적 성향이 있으며, 자존심이 높습니다. 작은 것에서도 아름다움을 찾아내는 안목이 있습니다.</p><p>섬세하고 날카로운 감각의 소유자로, 품격 있는 삶을 추구합니다. 비판적 사고력이 뛰어나 분석적인 일에 능숙합니다. 다만 예민한 성격으로 인해 상처를 잘 받을 수 있으며, 지나친 완벽주의가 스트레스의 원인이 될 수 있습니다.</p>`,
      '임': `<p>${name}님은 <strong>임수(壬水)</strong> 일간으로, 큰 바다나 강물처럼 넓고 깊은 기질을 타고났습니다. 포용력이 크고 지혜로우며, 큰 뜻을 품고 있습니다. 유연하면서도 강한 힘을 가지고 있어, 어떤 장애물도 돌아서 나아갈 수 있습니다.</p><p>호기심이 많고 다양한 분야에 관심을 가지며, 새로운 것을 탐구하는 것을 좋아합니다. 사교성이 좋고 다양한 인맥을 형성합니다. 다만 방향성을 잃으면 여기저기 흐르는 물처럼 일관성이 없어 보일 수 있으니, 명확한 목표 설정이 중요합니다.</p>`,
      '계': `<p>${name}님은 <strong>계수(癸水)</strong> 일간으로, 이슬이나 빗물처럼 맑고 순수한 기질을 타고났습니다. 직관력이 뛰어나고 감수성이 풍부하며, 내면이 깊습니다. 조용히 관찰하고 분석하는 능력이 뛰어나 통찰력 있는 판단을 합니다.</p><p>겸손하고 수용적인 태도로 주변의 호감을 얻으며, 세밀한 부분까지 놓치지 않는 꼼꼼함이 있습니다. 학문이나 연구, 예술 분야에서 재능을 보이며, 영적이거나 철학적인 관심이 높습니다. 다만 소극적이거나 우유부단해 보일 수 있으니 결단력을 키우는 것이 좋습니다.</p>`
    };

    text += personalities[dm] || '';

    // 십신 보정
    const strongest = dominant.strongest;
    if (strongest[1] > 0) {
      text += `<h4>십신으로 본 성격 보정</h4>`;
      const sipsinPersonality = {
        '비겁': `<p>비겁이 강하여 독립심과 주체성이 더욱 강화됩니다. 자기 길을 가는 성향이 강하며, 경쟁적인 환경에서 빛을 발합니다. 형제자매나 동료와의 관계가 성격 형성에 큰 영향을 미쳤을 수 있습니다.</p>`,
        '식상': `<p>식상이 강하여 창의적이고 표현력이 풍부한 성격이 더해집니다. 예술적 재능이 있으며, 자유로운 사고방식으로 독창적인 아이디어를 잘 냅니다. 맛있는 것을 좋아하고 삶을 즐기는 성향이 있습니다.</p>`,
        '재성': `<p>재성이 강하여 현실 감각이 뛰어나고 실리적인 성격이 더해집니다. 경제 관념이 확실하며 돈을 다루는 감각이 좋습니다. 부지런하고 활동적이며 사회생활에 적극적입니다.</p>`,
        '관성': `<p>관성이 강하여 책임감과 도덕심이 더해집니다. 규율을 중시하고 사회적 체면을 중요하게 여기며, 자기 절제력이 강합니다. 직장에서 인정받기 쉽지만 스트레스 관리에 유의해야 합니다.</p>`,
        '인성': `<p>인성이 강하여 학구적이고 사색적인 성격이 더해집니다. 배우는 것을 좋아하며 지식에 대한 욕구가 강합니다. 어머니 또는 스승의 영향을 많이 받았으며, 정신적 가치를 중시합니다.</p>`
      };
      text += sipsinPersonality[strongest[0]] || '';
    }

    // 계절 보정
    text += `<h4>태어난 계절의 영향</h4>`;
    const seasonPersonality = {
      '봄': `<p>${season}에 태어난 ${name}님은 생기와 활력이 넘칩니다. 새싹이 돋아나는 봄의 기운처럼 성장 지향적이고 희망적입니다. 새로운 시작을 잘하며, 시행착오를 두려워하지 않는 도전적 성향이 있습니다.</p>`,
      '여름': `<p>${season}에 태어난 ${name}님은 열정과 에너지가 넘칩니다. 뜨거운 여름의 기운처럼 활발하고 적극적이며, 밝은 성격으로 주변을 환하게 합니다. 감정이 풍부하고 표현력이 뛰어납니다.</p>`,
      '가을': `<p>${season}에 태어난 ${name}님은 성숙함과 결실의 기운을 가졌습니다. 가을의 풍성함처럼 내실을 중시하며, 깊이 있는 사고력을 지녔습니다. 판단력이 명확하고 결단력이 있습니다.</p>`,
      '겨울': `<p>${season}에 태어난 ${name}님은 깊은 내면의 힘을 가졌습니다. 겨울의 고요함처럼 침착하고 인내심이 강하며, 어려움 속에서도 흔들리지 않는 강인함이 있습니다. 사색적이고 지혜로운 성향입니다.</p>`
    };
    text += seasonPersonality[season] || '';

    return text;
  }

  // =====================================================
  // 6. 연애운
  // =====================================================
  generateRomance(ctx) {
    const { dm, dmElement, name, genderKo, gender, sipsin, pillars, strength } = ctx;
    const dominant = sipsin.dominant;

    let text = `<h4>${name}님의 연애운과 배우자운</h4>`;

    // 일간별 연애 스타일
    const romanceStyles = {
      '갑': `<p>${name}님은 연애에서도 당당하고 솔직한 스타일입니다. 상대방에게 진심을 숨기지 않으며, 리드하는 연애를 선호합니다. 자존심이 있어 먼저 다가가는 것을 꺼릴 수 있지만, 한 번 마음을 열면 한결같은 사랑을 합니다. 강한 보호본능이 있어 사랑하는 사람을 지키려는 마음이 강합니다.</p>`,
      '을': `<p>${name}님은 연애에서 유연하고 매력적인 스타일입니다. 상대방의 마음을 읽는 능력이 뛰어나며, 분위기를 잘 맞춥니다. 로맨틱한 감성이 풍부하고 데이트를 즐기며, 상대방을 세심하게 배려합니다. 다만 여러 사람에게 좋은 인상을 주어 오해를 살 수 있으니 주의하세요.</p>`,
      '병': `<p>${name}님은 연애에서 열정적이고 적극적인 스타일입니다. 한눈에 반하는 사랑을 경험하기 쉬우며, 사랑에 빠지면 온 세상이 밝아집니다. 사랑하는 사람에게 아낌없이 주는 타입이며, 함께하는 시간을 중시합니다. 다만 식을 때도 빠를 수 있으니 지속적인 관심 유지가 필요합니다.</p>`,
      '정': `<p>${name}님은 연애에서 깊고 진중한 스타일입니다. 가볍게 만나는 것보다 깊은 교감을 나눌 수 있는 사람을 원합니다. 은은한 매력으로 서서히 상대의 마음을 사로잡으며, 감성적이고 로맨틱합니다. 다만 속마음을 잘 표현하지 않아 오해를 살 수 있으니, 적극적인 표현이 필요합니다.</p>`,
      '무': `<p>${name}님은 연애에서 든든하고 안정적인 스타일입니다. 파트너에게 안정감을 주며, 한번 시작한 관계를 끝까지 지키려 합니다. 화려한 연애보다 편안한 관계를 선호하며, 실질적인 도움을 주는 것으로 사랑을 표현합니다. 다만 로맨틱한 표현이 부족할 수 있으니 가끔은 달콤한 말도 필요합니다.</p>`,
      '기': `<p>${name}님은 연애에서 세심하고 배려 깊은 스타일입니다. 상대방의 작은 변화도 놓치지 않고 챙기며, 모성애(부성애)적인 사랑을 합니다. 가정적이고 안정적인 관계를 지향하며, 파트너를 물심양면으로 지원합니다. 다만 지나친 걱정이 상대를 답답하게 할 수 있으니 적절한 거리감도 필요합니다.</p>`,
      '경': `<p>${name}님은 연애에서 직진형입니다. 마음에 드는 사람이 생기면 과감하게 다가가며, 숨김없이 진심을 전합니다. 의리 있는 사랑을 하며 배신을 용납하지 않습니다. 강하지만 사랑하는 사람 앞에서는 약해지는 갭이 매력적입니다. 다만 질투심이 강할 수 있으니 상대를 신뢰하는 연습이 필요합니다.</p>`,
      '신': `<p>${name}님은 연애에서 까다롭고 기준이 높은 스타일입니다. 아무에게나 쉽게 마음을 열지 않으며, 외모와 내면 모두를 보는 안목이 있습니다. 품격 있는 연애를 추구하며, 세련된 데이트를 즐깁니다. 상대방에 대한 기대가 높으므로, 완벽한 사람은 없다는 것을 인정하는 여유가 필요합니다.</p>`,
      '임': `<p>${name}님은 연애에서 넓고 자유로운 스타일입니다. 다양한 이성을 만나보는 것을 즐기며, 매력적이고 사교적이어서 인기가 많습니다. 자유를 중시하여 구속받는 것을 싫어하지만, 진정한 사랑을 만나면 깊이 빠져듭니다. 책임감 있는 태도로 관계를 발전시키는 것이 중요합니다.</p>`,
      '계': `<p>${name}님은 연애에서 순수하고 감성적인 스타일입니다. 마음이 통하는 사람과의 깊은 교감을 원하며, 영혼의 파트너를 찾으려 합니다. 감수성이 풍부하여 상대의 감정에 공감하는 능력이 뛰어납니다. 다만 이상이 높아 현실과의 괴리가 있을 수 있으니, 현실적인 시각도 필요합니다.</p>`
    };

    text += romanceStyles[dm] || '';

    // 배우자궁 분석 (일지)
    text += `<h4>배우자궁으로 본 인연</h4>`;
    const dayBranch = pillars.day.branch;
    const dayBranchEl = pillars.day.branchElement;

    text += `<p>일지(배우자궁)에 <strong>${dayBranch}(${dayBranchEl})</strong>이(가) 있습니다. `;

    const spouseTraits = {
      '자': '영리하고 재치 있는 배우자를 만날 가능성이 높습니다. 밤의 기운을 가진 자수(子水)는 지적이고 감성적인 파트너를 의미합니다.',
      '축': '성실하고 끈기 있는 배우자를 만날 가능성이 높습니다. 겨울의 마지막 기운인 축토(丑土)는 믿음직하고 근면한 파트너를 의미합니다.',
      '인': '활동적이고 도전적인 배우자를 만날 가능성이 높습니다. 봄의 시작인 인목(寅木)은 진취적이고 에너지 넘치는 파트너를 의미합니다.',
      '묘': '우아하고 세련된 배우자를 만날 가능성이 높습니다. 봄의 꽃인 묘목(卯木)은 예술적이고 감각적인 파트너를 의미합니다.',
      '진': '포용력 있고 든든한 배우자를 만날 가능성이 높습니다. 봄에서 여름으로 가는 진토(辰土)는 변화에 강하고 적응력 있는 파트너를 의미합니다.',
      '사': '똑똑하고 세련된 배우자를 만날 가능성이 높습니다. 여름의 시작인 사화(巳火)는 지적이고 활발한 파트너를 의미합니다.',
      '오': '열정적이고 밝은 배우자를 만날 가능성이 높습니다. 한여름의 오화(午火)는 에너지 넘치고 사교적인 파트너를 의미합니다.',
      '미': '다정하고 세심한 배우자를 만날 가능성이 높습니다. 여름의 끝인 미토(未土)는 따뜻하고 배려심 깊은 파트너를 의미합니다.',
      '신': '능력 있고 결단력 있는 배우자를 만날 가능성이 높습니다. 가을의 시작인 신금(申金)은 실행력과 추진력이 강한 파트너를 의미합니다.',
      '유': '세련되고 예리한 배우자를 만날 가능성이 높습니다. 가을의 유금(酉金)은 미적 감각이 뛰어나고 완벽주의적인 파트너를 의미합니다.',
      '술': '의리 있고 충직한 배우자를 만날 가능성이 높습니다. 가을의 끝인 술토(戌土)는 신뢰할 수 있고 보호적인 파트너를 의미합니다.',
      '해': '지혜롭고 포용력 있는 배우자를 만날 가능성이 높습니다. 겨울의 시작인 해수(亥水)는 깊이 있고 넓은 시야의 파트너를 의미합니다.'
    };

    text += `${spouseTraits[dayBranch] || ''}</p>`;

    // 십신으로 본 연애 패턴
    text += `<h4>십신으로 본 연애 패턴</h4>`;
    if (gender === 'male') {
      const jaesung = dominant.groups['재성'] || 0;
      if (jaesung >= 3) {
        text += `<p>재성이 많아 이성에 대한 관심이 높고 인연도 많은 편입니다. 여러 이성과의 만남이 있을 수 있으나, 진정한 사랑 하나에 집중하는 것이 행복의 열쇠입니다. 경제적으로도 파트너에게 베풀 능력이 있습니다.</p>`;
      } else if (jaesung === 0) {
        text += `<p>재성이 부족하여 이성과의 만남이 늦거나 인연이 쉽게 오지 않을 수 있습니다. 하지만 대운에서 재성이 들어오는 시기에 좋은 만남이 있을 수 있으니 조급해하지 마세요. 자기 자신을 발전시키는 것이 좋은 인연을 만드는 가장 좋은 방법입니다.</p>`;
      } else {
        text += `<p>재성이 적당히 있어 이성과의 관계가 자연스럽게 흘러갑니다. 적절한 시기에 좋은 인연을 만날 수 있으며, 안정적인 연애와 결혼 생활이 기대됩니다.</p>`;
      }
    } else {
      const gwansung = dominant.groups['관성'] || 0;
      if (gwansung >= 3) {
        text += `<p>관성이 많아 이성의 관심을 많이 받으며 인연이 풍부합니다. 여러 선택지 중에서 현명한 판단이 필요하며, 자기 자신의 기준을 확고히 하는 것이 중요합니다. 능력 있는 파트너를 만날 가능성이 높습니다.</p>`;
      } else if (gwansung === 0) {
        text += `<p>관성이 부족하여 배우자와의 인연이 늦거나, 독립적인 삶을 선호할 수 있습니다. 대운에서 관성이 들어오는 시기에 인연의 기회가 올 수 있습니다. 스스로의 가치를 인정하고 자신감을 갖는 것이 중요합니다.</p>`;
      } else {
        text += `<p>관성이 적당히 있어 이성과의 관계가 안정적입니다. 좋은 시기에 좋은 인연을 만나 행복한 관계를 형성할 수 있으며, 서로 존중하는 파트너십을 만들어갈 수 있습니다.</p>`;
      }
    }

    return text;
  }

  // =====================================================
  // 7. 재물운
  // =====================================================
  generateWealth(ctx) {
    const { dm, dmElement, name, sipsin, strength, season, daewoon } = ctx;
    const dominant = sipsin.dominant;

    let text = `<h4>${name}님의 재물운</h4>`;

    // 일간별 재물 성향
    const wealthStyles = {
      '갑': `<p>갑목 일간의 ${name}님은 큰 나무가 많은 열매를 맺듯이 재물을 모을 수 있는 기본적인 역량이 있습니다. 새로운 사업을 시작하거나 개척하는 분야에서 재물을 얻기 쉽습니다. 정직하고 바른 방법으로 재물을 추구하며, 의리를 중시하여 사업 파트너들의 신뢰를 얻을 수 있습니다.</p>`,
      '을': `<p>을목 일간의 ${name}님은 유연한 처세로 다양한 경로에서 재물을 만들어낼 수 있습니다. 사교성을 활용한 네트워크 비즈니스나, 미적 감각을 살린 분야에서 수익을 올릴 수 있습니다. 부드러운 접근으로 거래처를 확보하는 능력이 뛰어납니다.</p>`,
      '병': `<p>병화 일간의 ${name}님은 밝은 에너지로 재물을 끌어당기는 힘이 있습니다. 대중을 상대하는 사업이나 인기를 기반으로 한 활동에서 큰 수익을 올릴 수 있습니다. 투자에도 과감하지만, 충동적 소비를 조심해야 합니다.</p>`,
      '정': `<p>정화 일간의 ${name}님은 지적 능력을 활용하여 재물을 만드는 타입입니다. 전문 지식이나 기술을 통한 수입이 기대되며, 특허나 저작권 등 지식재산으로 수익을 올릴 수 있습니다. 투기보다는 안정적인 투자가 적합합니다.</p>`,
      '무': `<p>무토 일간의 ${name}님은 부동산이나 토지 관련 재물 운이 있습니다. 안정적인 자산을 차근차근 쌓아가는 스타일이며, 장기 투자에 적합합니다. 사람들의 신뢰를 바탕으로 큰 거래를 성사시킬 수 있는 능력이 있습니다.</p>`,
      '기': `<p>기토 일간의 ${name}님은 꾸준한 노력으로 재물을 모으는 타입입니다. 알뜰하고 실용적인 소비 습관이 있으며, 작은 돈도 소중히 여깁니다. 부동산이나 실물 자산에 대한 감각이 있으며, 생활 밀착형 사업에서 수익을 올릴 수 있습니다.</p>`,
      '경': `<p>경금 일간의 ${name}님은 강한 추진력으로 재물을 만들어내는 타입입니다. 결단력 있는 투자와 과감한 사업 추진으로 큰 수익을 올릴 수 있습니다. 금융이나 기술 분야에서 재물 운이 좋으며, 원칙을 지키면서도 승부를 볼 줄 아는 재테크 능력이 있습니다.</p>`,
      '신': `<p>신금 일간의 ${name}님은 세밀한 분석으로 재물을 다루는 타입입니다. 가치 있는 것을 알아보는 안목이 있어 보석, 예술품, 고급 브랜드 관련 사업에서 수익을 올릴 수 있습니다. 품격 있는 소비를 하되, 실속도 챙기는 지혜가 필요합니다.</p>`,
      '임': `<p>임수 일간의 ${name}님은 유동적인 재물 운을 가졌습니다. 큰 물이 흐르듯 재물이 크게 들어오기도 하지만 나가기도 합니다. 무역, 유통, IT 등 유동적인 분야에서 큰 수익을 올릴 수 있습니다. 재물 관리에 체계를 세우는 것이 중요합니다.</p>`,
      '계': `<p>계수 일간의 ${name}님은 지혜를 활용한 재물 운이 있습니다. 정보력과 분석력을 바탕으로 투자 수익을 올릴 수 있으며, 교육이나 연구 분야에서의 수입도 기대됩니다. 큰 모험보다는 안정적인 방법으로 재물을 관리하는 것이 좋습니다.</p>`
    };

    text += wealthStyles[dm] || '';

    // 신강/신약에 따른 재물 운
    text += `<h4>사주 강약으로 본 재물 흐름</h4>`;
    if (strength.level === 'strong') {
      text += `<p>신강한 사주이므로 재성(재물)을 감당할 수 있는 힘이 있습니다. 적극적으로 재물을 추구해도 좋으며, 사업이나 투자에서 과감한 시도가 성과를 가져올 수 있습니다. 다만 재물에 대한 욕심이 지나치면 화를 부를 수 있으니 적절한 선에서 만족하는 지혜가 필요합니다.</p>`;
    } else if (strength.level === 'weak') {
      text += `<p>신약한 사주이므로 큰 재물을 한꺼번에 감당하기 어려울 수 있습니다. 큰 투자나 무리한 사업 확장보다는 안정적인 수입원을 유지하면서 차근차근 모아가는 것이 좋습니다. 동업보다는 개인 사업이, 투기보다는 저축이 적합합니다. 건강을 잘 관리하여 지속적으로 경제활동을 할 수 있는 체력을 유지하는 것이 재물 운의 핵심입니다.</p>`;
    } else {
      text += `<p>중화된 사주이므로 재물 운이 고르게 분포되어 있습니다. 극단적인 대박이나 쪽박보다는 꾸준한 성장이 기대됩니다. 안정 속에서 기회를 노리는 전략이 효과적이며, 분산 투자가 적합합니다.</p>`;
    }

    // 재성 분석
    const jaesung = dominant.groups['재성'] || 0;
    text += `<h4>재성으로 본 재물의 크기</h4>`;
    if (jaesung >= 3) {
      text += `<p>사주에 재성이 풍부하여 재물과의 인연이 깊습니다. 다양한 경로로 수입이 들어오며, 재물을 다루는 감각이 타고났습니다. 다만 너무 많은 재성은 일간을 약하게 할 수 있으므로, 건강과 체력 관리에 신경 쓰면서 재물 활동을 해야 합니다.</p>`;
    } else if (jaesung === 0) {
      text += `<p>사주에 재성이 없어 재물과의 직접적 인연이 약할 수 있습니다. 하지만 대운이나 세운에서 재성이 들어올 때 큰 기회가 올 수 있습니다. 평소에는 기술이나 전문성을 쌓아 간접적으로 재물을 만드는 것이 좋습니다.</p>`;
    } else {
      text += `<p>사주에 재성이 적당히 있어 재물 운이 안정적입니다. 무리하지 않으면 꾸준히 재물을 쌓아갈 수 있으며, 중년 이후 더욱 안정적인 재정 상태를 기대할 수 있습니다.</p>`;
    }

    return text;
  }

  // =====================================================
  // 8. 직업운
  // =====================================================
  generateCareer(ctx) {
    const { dm, dmElement, name, sipsin, strength, genderKo } = ctx;
    const dominant = sipsin.dominant;

    let text = `<h4>${name}님의 직업운과 적성</h4>`;

    // 일간별 적성
    const careerMap = {
      '갑': `<p>갑목 일간의 ${name}님은 리더십을 발휘할 수 있는 분야가 적합합니다. 경영, 정치, 교육, 법조계, 의료 등 사람들을 이끌고 가르치는 분야에서 두각을 나타냅니다. 창업에도 적합하며, 특히 새로운 분야를 개척하는 벤처나 스타트업에서 강점을 보입니다. 임업, 건설, 교육 분야와도 인연이 있습니다.</p>`,
      '을': `<p>을목 일간의 ${name}님은 사교성과 섬세함을 살릴 수 있는 분야가 적합합니다. 디자인, 패션, 미용, 꽃집, 인테리어 등 아름다움과 관련된 분야에서 재능을 발휘합니다. 외교, 상담, 서비스 분야에서도 좋은 성과를 낼 수 있습니다. 유연한 적응력으로 다양한 환경에서 성공할 수 있습니다.</p>`,
      '병': `<p>병화 일간의 ${name}님은 대중 앞에서 빛나는 분야가 적합합니다. 방송, 연예, 마케팅, 영업, 강연 등 사람들과 교류하는 분야에서 두각을 나타냅니다. 에너지 분야, 전기전자, 조명 관련 사업과도 인연이 있습니다. 열정을 쏟을 수 있는 일에서 최고의 성과를 냅니다.</p>`,
      '정': `<p>정화 일간의 ${name}님은 지적 분야에서 재능을 발휘합니다. 연구, 교수, 작가, 프로그래머, 분석가 등 깊이 있는 사고를 요하는 분야가 적합합니다. 문화예술, 종교, 철학 분야에서도 인연이 있습니다. 집중력을 요하는 전문직에서 좋은 성과를 냅니다.</p>`,
      '무': `<p>무토 일간의 ${name}님은 안정적이고 신뢰가 중요한 분야가 적합합니다. 부동산, 건축, 금융, 공무원, 농업 등 안정적인 기반을 다루는 분야에서 능력을 발휘합니다. 중재나 컨설팅 분야에서도 좋은 성과를 낼 수 있으며, 장기적인 관점에서 사업을 운영하는 데 적합합니다.</p>`,
      '기': `<p>기토 일간의 ${name}님은 세심함과 실용성을 살릴 수 있는 분야가 적합합니다. 식품, 농업, 의료, 보육, 서비스 분야에서 재능을 발휘합니다. 회계, 경리, 사무 관리 등 꼼꼼함이 필요한 일에도 적합합니다. 사람을 돌보는 일에서 보람과 성취를 느낍니다.</p>`,
      '경': `<p>경금 일간의 ${name}님은 강한 추진력을 살릴 수 있는 분야가 적합합니다. 군인, 경찰, 법조인, 외과의, 엔지니어 등 결단력과 실행력이 필요한 분야에서 두각을 나타냅니다. 금속, 기계, 자동차, IT 분야와도 인연이 있습니다. 경쟁이 치열한 환경에서 더 빛을 발합니다.</p>`,
      '신': `<p>신금 일간의 ${name}님은 섬세함과 전문성을 살릴 수 있는 분야가 적합합니다. 보석, 귀금속, 패션, 의료(특히 치과/피부과), 미용 분야에서 재능을 발휘합니다. 금융 분석, 감정(鑑定), 편집 등 세밀한 작업이 필요한 분야에도 적합합니다.</p>`,
      '임': `<p>임수 일간의 ${name}님은 유동적이고 넓은 분야가 적합합니다. 무역, 유통, 해운, 여행, IT, 미디어 등 세계를 무대로 활동하는 분야에서 능력을 발휘합니다. 사업 수완이 좋아 큰 사업체를 운영하는 데도 적합하며, 다양한 인맥을 활용한 비즈니스에 강합니다.</p>`,
      '계': `<p>계수 일간의 ${name}님은 지혜와 감수성을 살릴 수 있는 분야가 적합합니다. 연구, 교육, 심리상담, 작가, 종교, 점술 등 내면의 깊이가 필요한 분야에서 재능을 발휘합니다. 의약, 바이오, 수산업 분야와도 인연이 있습니다.</p>`
    };

    text += careerMap[dm] || '';

    // 십신으로 본 직업 적성
    text += `<h4>십신으로 본 직업 방향</h4>`;
    const strongest = dominant.strongest;
    const sipsinCareer = {
      '비겁': `<p>비겁이 강하여 독립적인 직업이 적합합니다. 자영업, 프리랜서, 1인 기업, 스포츠 선수 등 자기 능력으로 승부하는 분야에서 성공할 수 있습니다. 경쟁적인 환경에서 동기부여를 받으며, 동업보다는 독립 경영이 어울립니다.</p>`,
      '식상': `<p>식상이 강하여 창의적인 직업이 적합합니다. 예술가, 디자이너, 작가, 셰프, 연예인, 크리에이터 등 자기표현을 통해 가치를 만드는 분야에서 두각을 나타냅니다. 기술직이나 전문 기능직에서도 좋은 성과를 낼 수 있습니다.</p>`,
      '재성': `<p>재성이 강하여 사업가 기질이 있습니다. 장사, 무역, 유통, 부동산, 금융 등 재물을 직접 다루는 분야에서 성공할 수 있습니다. 현실 감각이 뛰어나 투자나 재테크에서도 좋은 성과를 기대할 수 있습니다.</p>`,
      '관성': `<p>관성이 강하여 조직 내에서 성공하기 좋습니다. 공무원, 대기업 임원, 관리직, 법조인, 행정가 등 안정적인 조직에서 높은 자리에 오를 수 있습니다. 규율과 질서가 있는 환경에서 능력을 발휘합니다.</p>`,
      '인성': `<p>인성이 강하여 학문과 교육 분야가 적합합니다. 교수, 교사, 연구원, 학자, 전문 자격사 등 지식을 다루는 분야에서 성공할 수 있습니다. 평생 학습자로서 지속적인 자기 발전이 직업적 성공의 열쇠입니다.</p>`
    };

    text += sipsinCareer[strongest[0]] || '';

    return text;
  }

  // =====================================================
  // 9. 건강운
  // =====================================================
  generateHealth(ctx) {
    const { dm, dmElement, name, elements, strength, season } = ctx;

    let text = `<h4>${name}님의 건강운</h4>`;

    // 오행별 장부 대응
    const organMap = {
      '목': { organs: '간(肝)과 담(膽)', symptoms: '눈의 피로, 근육 경련, 화가 잘 남, 소화 장애', advice: '봄나물 섭취, 눈 휴식, 스트레칭, 산림욕' },
      '화': { organs: '심장(心)과 소장(小腸)', symptoms: '가슴 두근거림, 불면증, 혀 질환, 혈액순환 장애', advice: '충분한 수면, 명상, 가벼운 유산소 운동, 쓴맛 음식' },
      '토': { organs: '비(脾)와 위(胃)', symptoms: '소화불량, 식욕부진, 근육 무력, 당뇨 주의', advice: '규칙적인 식사, 과식 자제, 단맛 과다 섭취 주의, 걷기 운동' },
      '금': { organs: '폐(肺)와 대장(大腸)', symptoms: '호흡기 질환, 피부 트러블, 알레르기, 변비', advice: '심호흡, 깨끗한 공기, 매운 음식 적당히, 피부 관리' },
      '수': { organs: '신장(腎)과 방광(膀胱)', symptoms: '요통, 부종, 생식기 관련, 뼈 관절 문제', advice: '충분한 수분 섭취, 짠 음식 줄이기, 하체 운동, 족욕' }
    };

    // 일간 오행 관련 건강
    const dmOrgan = organMap[dmElement];
    text += `<p>${name}님의 일간 ${dm}(${dmElement})과 관련된 주요 장부는 <strong>${dmOrgan.organs}</strong>입니다. 이 부분이 체질적으로 민감할 수 있으며, 평소 관리가 중요합니다.</p>`;
    text += `<p>주의할 증상: ${dmOrgan.symptoms}</p>`;
    text += `<p>건강 관리 방법: ${dmOrgan.advice}</p>`;

    // 부족한 오행 관련 건강
    const { missing, weakest } = elements;
    if (missing.length > 0) {
      text += `<h4>부족한 오행으로 본 취약 부위</h4>`;
      missing.forEach(el => {
        const info = organMap[el];
        text += `<p><strong>${el}(${info.organs})</strong>이 사주에 없어 이 부분의 건강에 특별한 주의가 필요합니다. ${info.symptoms} 등의 증상이 나타날 수 있습니다. ${info.advice}을(를) 실천하세요.</p>`;
      });
    } else {
      const weakOrgan = organMap[weakest.element];
      text += `<h4>가장 약한 오행으로 본 주의점</h4>`;
      text += `<p>가장 약한 오행인 <strong>${weakest.element}(${weakOrgan.organs})</strong>과 관련된 건강에 주의가 필요합니다. ${weakOrgan.symptoms} 등의 증상이 나타날 수 있으며, ${weakOrgan.advice}을(를) 실천하면 좋습니다.</p>`;
    }

    // 과다한 오행 관련
    const { strongest } = elements;
    if (strongest.count >= 4) {
      const strongOrgan = organMap[strongest.element];
      text += `<h4>과다한 오행으로 본 주의점</h4>`;
      text += `<p>${strongest.element} 기운이 과다합니다. ${strongOrgan.organs}이 과도하게 활성화되어 역효과가 날 수 있습니다. ${strongOrgan.symptoms}이 심해질 수 있으니 균형 잡힌 생활이 중요합니다.</p>`;
    }

    // 신강/신약별 건강 조언
    text += `<h4>체질별 건강 관리</h4>`;
    if (strength.level === 'strong') {
      text += `<p>신강한 체질이므로 기본적인 체력은 좋은 편입니다. 하지만 과신하여 건강 관리를 소홀히 하기 쉬우니 주의하세요. 에너지가 넘쳐 과로하기 쉬우며, 스트레스를 운동으로 풀어주는 것이 좋습니다. 강도 높은 운동(웨이트, 마라톤, 격투기 등)이 적합하며, 여가 활동으로 에너지를 건강하게 발산하세요.</p>`;
    } else if (strength.level === 'weak') {
      text += `<p>신약한 체질이므로 체력 관리에 더욱 신경 써야 합니다. 과로를 피하고 규칙적인 생활 패턴을 유지하세요. 가벼운 유산소 운동(걷기, 요가, 수영)이 적합하며, 영양 섭취에 신경 쓰되 과식은 피하세요. 충분한 수면이 특히 중요합니다. 계절 변화에 민감할 수 있으니 환절기 건강 관리에 주의하세요.</p>`;
    } else {
      text += `<p>중화된 체질이므로 전반적인 건강 균형이 양호합니다. 현재의 건강 상태를 유지하면서 부족한 부분을 보완해나가면 됩니다. 유산소와 근력 운동을 균형 있게 병행하고, 다양한 식재료를 골고루 섭취하세요.</p>`;
    }

    // 계절별 건강 조언
    text += `<h4>태어난 계절별 건강 특성</h4>`;
    const seasonHealth = {
      '봄': `<p>${season}에 태어나 목(木)의 기운이 강합니다. 간과 담의 건강에 특히 주의하며, 봄철 알레르기나 피로에 유의하세요. 신선한 채소를 많이 섭취하고, 산책을 즐기면 건강 유지에 도움이 됩니다.</p>`,
      '여름': `<p>${season}에 태어나 화(火)의 기운이 강합니다. 심장과 혈관 건강에 주의하며, 여름철 열사병이나 탈수에 유의하세요. 수분 섭취를 충분히 하고, 명상이나 호흡 운동으로 심신을 안정시키세요.</p>`,
      '가을': `<p>${season}에 태어나 금(金)의 기운이 강합니다. 폐와 호흡기 건강에 주의하며, 가을철 건조함으로 인한 피부 트러블에 유의하세요. 심호흡 운동과 충분한 보습이 도움이 됩니다.</p>`,
      '겨울': `<p>${season}에 태어나 수(水)의 기운이 강합니다. 신장과 비뇨기 건강에 주의하며, 겨울철 추위로 인한 관절통에 유의하세요. 따뜻한 음식을 섭취하고 하체를 따뜻하게 유지하세요.</p>`
    };
    text += seasonHealth[season] || '';

    return text;
  }

  // =====================================================
  // 10. 올해 운세 (2026 병오년)
  // =====================================================
  generateYearFortune(ctx) {
    const { dm, dmElement, name, daewoon, sipsin, elements } = ctx;
    const yearFortune = daewoon.yearFortune;

    let text = `<h4>2026년 병오(丙午)년 운세</h4>`;
    text += `<p>2026년은 <strong>병오(丙午)년</strong>으로, 천간 병(丙, 양화)과 지지 오(午, 양화)가 만난 해입니다. 화(火)의 기운이 매우 강한 해로, 열정과 활동성이 넘치는 한 해가 될 것입니다.</p>`;

    // 일간과 세운의 관계
    const cycle = ['목', '화', '토', '금', '수'];
    const dmIdx = cycle.indexOf(dmElement);
    const yearEl = '화'; // 병오년은 화
    const yearIdx = cycle.indexOf(yearEl);

    text += `<h4>${dm} 일간과 병오년의 관계</h4>`;

    if (dmElement === '화') {
      text += `<p>${name}님의 일간 ${dm}(${dmElement})과 올해 병오의 기운이 같은 화(火)입니다. 비겁의 해로, 자아가 강해지고 독립적인 활동이 활발해집니다. 경쟁이 치열해질 수 있지만, 자신감도 함께 올라갑니다. 동료나 형제와의 협력이 중요하며, 동업이나 공동 프로젝트에서 좋은 성과를 기대할 수 있습니다.</p>`;
    } else if ((dmIdx + 1) % 5 === yearIdx) {
      text += `<p>${name}님의 일간 ${dm}(${dmElement})이 올해의 화 기운을 생해줍니다. 식상의 해로, 자기 표현과 창작 활동에 유리합니다. 새로운 아이디어나 프로젝트를 시작하기 좋으며, 재능이 빛을 발할 수 있습니다. 다만 에너지 소모가 크므로 건강 관리에 신경 쓰세요.</p>`;
    } else if ((dmIdx + 2) % 5 === yearIdx) {
      text += `<p>${name}님의 일간 ${dm}(${dmElement})이 올해의 화 기운을 극합니다. 재성의 해로, 재물 운이 상승합니다. 사업 확장이나 투자에 좋은 시기이며, 수입 증가를 기대할 수 있습니다. 적극적인 경제 활동이 좋은 결과를 가져옵니다.</p>`;
    } else if ((yearIdx + 2) % 5 === dmIdx) {
      text += `<p>올해의 화 기운이 ${name}님의 일간 ${dm}(${dmElement})을 극합니다. 관성의 해로, 외부의 압력이나 변화가 있을 수 있습니다. 직장에서의 변동, 승진 시험, 공적 평가 등이 예상됩니다. 도전적인 상황이 성장의 기회가 될 수 있으니, 겸허하게 대처하세요.</p>`;
    } else {
      text += `<p>올해의 화 기운이 ${name}님의 일간 ${dm}(${dmElement})을 생해줍니다. 인성의 해로, 학업과 자기 발전에 유리합니다. 새로운 것을 배우거나 자격증을 따기 좋으며, 윗사람이나 스승의 도움을 받을 수 있습니다. 정신적으로 풍요로운 한 해가 될 것입니다.</p>`;
    }

    // 월별 운세 개요
    text += `<h4>2026년 월별 운세 개요</h4>`;
    const monthlyFortunes = [
      { month: '1~2월', desc: '새해의 시작과 함께 계획을 세우기 좋은 시기입니다. 입춘 이후 새로운 기운이 유입됩니다.' },
      { month: '3~4월', desc: '봄의 기운과 함께 활동성이 높아집니다. 새로운 프로젝트나 인간관계를 시작하기 좋습니다.' },
      { month: '5~6월', desc: '화(火)의 기운이 점점 강해지면서 열정이 최고조에 달합니다. 과로에 주의하되 적극적으로 행동하세요.' },
      { month: '7~8월', desc: '한여름 화기가 극에 달하므로 건강 관리에 특히 주의하세요. 중요한 결정은 신중하게 내리세요.' },
      { month: '9~10월', desc: '가을의 금 기운이 화를 조절해줍니다. 수확의 시기로, 상반기 노력의 결실을 거둘 수 있습니다.' },
      { month: '11~12월', desc: '수 기운이 강해지며 정리의 시기입니다. 한 해를 마무리하고 다음 해를 준비하세요.' }
    ];

    text += `<p>`;
    monthlyFortunes.forEach(mf => {
      text += `<strong>${mf.month}:</strong> ${mf.desc}<br>`;
    });
    text += `</p>`;

    // 현재 대운과의 복합 분석
    if (daewoon.currentDaewoon) {
      text += `<h4>현재 대운과 세운의 복합 분석</h4>`;
      const cd = daewoon.currentDaewoon;
      text += `<p>현재 ${cd.display} 대운(${cd.ageRange})을 지나면서 2026년 병오년을 맞이하셨습니다. 대운의 ${cd.element}/${cd.branchElement} 기운과 세운의 화/화 기운이 만나 `;

      if (cd.element === '화' || cd.branchElement === '화') {
        text += `화 기운이 더욱 강해지는 시기입니다. 열정적이고 활동적인 한 해가 되겠지만, 과열에 주의하세요. 심장과 혈관 건강을 챙기고, 감정 조절에 신경 쓰세요.</p>`;
      } else if (cd.element === '수' || cd.branchElement === '수') {
        text += `수화(水火)의 충돌이 있을 수 있습니다. 갈등이나 내적 고민이 생길 수 있지만, 이를 통해 더 성숙해질 수 있습니다. 중요한 결정 앞에서 감정보다 이성을 우선하세요.</p>`;
      } else if (cd.element === '목' || cd.branchElement === '목') {
        text += `목생화(木生火)의 흐름이 만들어집니다. 자연스러운 성장과 발전이 기대되며, 계획한 일들이 순조롭게 진행될 수 있습니다.</p>`;
      } else if (cd.element === '토' || cd.branchElement === '토') {
        text += `화생토(火生土)의 흐름이 만들어집니다. 안정적인 기반을 다지기 좋은 시기이며, 부동산이나 자산 관리에 유리합니다.</p>`;
      } else {
        text += `금 기운과 화 기운의 상호작용이 있습니다. 변화와 조정의 시기로, 유연한 대처가 필요합니다.</p>`;
      }
    }

    return text;
  }

  // =====================================================
  // 11. 종합 조언
  // =====================================================
  generateAdvice(ctx) {
    const { dm, dmElement, name, sipsin, strength, elements, daewoon, season, genderKo } = ctx;
    const dominant = sipsin.dominant;
    const { missing } = elements;

    let text = `<h4>종합 조언</h4>`;

    text += `<p>${name}님의 사주를 전체적으로 살펴보았습니다. 마지막으로 ${name}님의 삶을 더 풍요롭게 만들어줄 종합적인 조언을 드리겠습니다.</p>`;

    // 강점
    text += `<h4>타고난 강점</h4>`;
    text += `<p>`;
    const strengthAdvice = {
      '갑': '개척정신과 리더십이 뛰어나며, 정의감이 강합니다.',
      '을': '유연한 적응력과 사교성이 뛰어나며, 예술적 감각이 있습니다.',
      '병': '밝은 에너지와 카리스마가 있으며, 사람들을 이끄는 힘이 있습니다.',
      '정': '깊은 통찰력과 집중력이 있으며, 섬세한 감수성의 소유자입니다.',
      '무': '듬직한 안정감과 포용력이 있으며, 사람들의 신뢰를 얻습니다.',
      '기': '세심한 배려와 실용적 감각이 있으며, 꾸준히 노력합니다.',
      '경': '강한 결단력과 실행력이 있으며, 의리를 중시합니다.',
      '신': '세련된 감각과 분석력이 있으며, 완벽을 추구합니다.',
      '임': '넓은 포용력과 사업 수완이 있으며, 지혜롭습니다.',
      '계': '깊은 직관력과 감수성이 있으며, 순수한 마음을 가졌습니다.'
    };
    text += `${name}님은 ${dm} 일간으로 ${strengthAdvice[dm]} `;

    const strongGroup = dominant.strongest[0];
    const sipsinStrength = {
      '비겁': '독립적으로 일을 추진하는 힘이 있으며, 자기만의 길을 개척해 나갈 수 있습니다.',
      '식상': '창의적 재능이 풍부하며, 자기 표현을 통해 가치를 만들어낼 수 있습니다.',
      '재성': '현실 감각이 뛰어나며, 재물을 다루는 능력이 있습니다.',
      '관성': '사회적 책임감이 강하며, 조직 내에서 높은 위치에 오를 수 있습니다.',
      '인성': '학문적 재능이 있으며, 깊은 사고력으로 지혜를 쌓아갑니다.'
    };
    text += `십신으로 보면 ${strongGroup}이(가) 강하여 ${sipsinStrength[strongGroup]}</p>`;

    // 보완할 점
    text += `<h4>보완할 점</h4>`;
    const weakGroup = dominant.weakest[0];
    const sipsinWeak = {
      '비겁': '자기 주관과 독립심을 키우세요. 자신의 의견을 당당히 표현하고, 스스로 결정하는 연습을 하세요.',
      '식상': '자기 표현의 통로를 만드세요. 취미활동이나 창작 활동을 통해 내면의 감정을 건강하게 표출하세요.',
      '재성': '재물 관리에 관심을 가지세요. 경제 공부를 하고, 재테크를 시작해보세요. 현실적인 목표를 세우는 것이 중요합니다.',
      '관성': '자기 절제와 책임감을 길러보세요. 규칙적인 생활 습관을 만들고, 사회적 규범을 존중하는 태도를 가지세요.',
      '인성': '꾸준한 학습과 자기 발전에 투자하세요. 독서, 강의 수강, 자격증 공부 등으로 지식을 쌓으면 인생에 큰 도움이 됩니다.'
    };
    text += `<p>${sipsinWeak[weakGroup]}</p>`;

    // 부족한 오행 보완
    if (missing.length > 0) {
      text += `<h4>오행 보완 방법</h4>`;
      const elementCompensation = {
        '목': '초록색 소품이나 의류를 활용하고, 식물을 가까이 하세요. 동쪽 방향이 좋으며, 산책이나 등산을 즐기세요.',
        '화': '빨간색이나 보라색 소품을 활용하고, 밝은 조명의 환경을 만드세요. 남쪽 방향이 좋으며, 사교 활동을 늘리세요.',
        '토': '황색이나 갈색 계열을 활용하고, 안정적인 환경을 조성하세요. 중앙이 좋으며, 정원 가꾸기나 요리를 즐기세요.',
        '금': '흰색이나 금색 소품을 활용하고, 깨끗하고 정돈된 환경을 유지하세요. 서쪽 방향이 좋으며, 음악 감상이 도움이 됩니다.',
        '수': '검정이나 남색 계열을 활용하고, 물 가까운 곳을 찾으세요. 북쪽 방향이 좋으며, 수영이나 온천이 도움이 됩니다.'
      };
      missing.forEach(el => {
        text += `<p><strong>${el} 보완:</strong> ${elementCompensation[el]}</p>`;
      });
    }

    // 2026년 특별 조언
    text += `<h4>2026년을 위한 조언</h4>`;
    text += `<p>2026년 병오년은 화(火)의 기운이 매우 강한 해입니다. `;

    if (dmElement === '목') {
      text += `${dm} 일간에게는 목생화(木生火)의 흐름으로 에너지가 빠져나갈 수 있습니다. 체력 관리에 신경 쓰면서 자기 표현과 창작 활동에 힘쓰면 좋은 결과를 얻을 수 있습니다.`;
    } else if (dmElement === '화') {
      text += `${dm} 일간에게는 같은 화 기운이 합류하여 기운이 매우 강해집니다. 자신감과 활력이 넘치지만, 과열에 주의하세요. 경쟁 상황에서 유리하며 자기 사업이나 프로젝트에 좋습니다.`;
    } else if (dmElement === '토') {
      text += `${dm} 일간에게는 화생토(火生土)의 흐름으로 도움을 받는 해입니다. 학업, 자격증, 지식 분야에서 성과를 거둘 수 있으며, 윗사람의 도움이 있습니다.`;
    } else if (dmElement === '금') {
      text += `${dm} 일간에게는 화극금(火剋金)의 흐름으로 도전적인 해입니다. 직장이나 사회적 활동에서 압박이 있을 수 있지만, 이를 통해 단련되고 성장합니다.`;
    } else {
      text += `${dm} 일간에게는 재물의 기회가 오는 해입니다. 수극화(水剋火)의 흐름으로 적극적인 재물 활동이 성과를 가져옵니다. 투자나 사업에 좋은 시기입니다.`;
    }
    text += `</p>`;

    // 마무리
    text += `<h4>마무리하며</h4>`;
    text += `<p>사주는 타고난 기질과 운의 흐름을 보여주지만, 결코 운명이 정해져 있다는 의미는 아닙니다. 사주를 통해 자신의 강점을 알고 약점을 보완하며, 좋은 시기에는 과감하게 나아가고 어려운 시기에는 인내하며 준비하는 것이 지혜로운 삶입니다.</p>`;
    text += `<p>${name}님은 ${dm} 일간의 아름다운 기운을 가지고 이 세상에 오셨습니다. 자신의 장점을 살리고 부족한 부분을 꾸준히 채워나가며, 주변 사람들과 좋은 관계를 맺어가시길 바랍니다. 사주에서 보이는 운의 흐름은 참고자료일 뿐, 실제 인생을 만들어가는 것은 ${name}님 자신입니다.</p>`;
    text += `<p>건강하고 행복한 삶을 기원합니다. 🙏</p>`;

    return text;
  }
}
